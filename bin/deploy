#!/usr/bin/env bash -e

TMP_S3CONFIG="$PWD/tmp/s3cfg"
mkdir -p "$PWD/tmp"

# Generate the s3cmd config file to tmp

cat > "$TMP_S3CONFIG" <<CONFIG
[default]
bucket_location = EU
default_mime_type = binary/octet-stream
delete_removed = False
guess_mime_type = True
host_base = s3.amazonaws.com
host_bucket = %(bucket)s.s3.amazonaws.com
human_readable_sizes = True
preserve_attrs = True
progress_meter = True
skip_existing = False
use_https = True
verbosity = INFO
CONFIG

save_option () {
  echo $* >> "$TMP_S3CONFIG"
}

save_option "access_key = $AWS_ACCESS_KEY_SWAGGER"
save_option "secret_key = $AWS_SECRET_KEY_SWAGGER"

cd dist

S3_BUCKET="$S3_BUCKET_SWAGGER" \
S3CMD_OPTIONS="--config \"$TMP_S3CONFIG\" sync" \
STRATEGY=s3 \
deliver $*

cd ..

rm "$TMP_S3CONFIG"
